---
title: "party-change"
output: html_document
date: "2025-12-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## R Markdown

# Load necessary libraries
```{r}
install.packages("tidyr") 
install.packages("writexl")
install.packages("data.table")
install.packages("knitr")
library(data.table)
library(knitr)
library (writexl)
library(tidyr)
```

```{r}
# Load necessary library
library(dplyr)
 
```  


```{r}
#statewide voter registration file found here: https://www.ncsbe.gov/results-data/voter-registration-data. File was pulled on Dec. 18 

library(data.table)

zip_url <- "https://s3.amazonaws.com/dl.ncsbe.gov/data/ncvoter_Statewide.zip"
zip_path <- tempfile(fileext = ".zip")

download.file(zip_url, zip_path, mode = "wb")

# See what's inside the zip
contents <- unzip(zip_path, list = TRUE)
contents

csv_path <- unzip(zip_path, files = contents$Name[1])  
file.info(csv_path)$size

voter_file <- fread(
  csv_path,
  sep = "\t",
  encoding = "UTF-8",
  showProgress = TRUE
)

nrow(voter_file)
ncol(voter_file) 
```

```{r}

# NC voter history file (NCVHIS) layout:

# tab delimited, last 10 years, point-in-time snapshot.

# Can be linked to ncvoter by ncid (best) or by (county_desc + voter_reg_num).

library(data.table)

zip_url_his <- "https://s3.amazonaws.com/dl.ncsbe.gov/data/ncvhis_Statewide.zip"
zip_path_his <- tempfile(fileext = ".zip")

download.file(zip_url_his, zip_path_his, mode = "wb")

contents_his <- unzip(zip_path_his, list = TRUE)
contents_his

his_path <- unzip(zip_path_his, files = contents_his$Name[1])

ncvhis <- fread(
his_path,
sep = "\t",
encoding = "UTF-8",
showProgress = TRUE
)

#nrow(ncvhis)
#ncol(ncvhis)
#names(ncvhis)
```


```{r}
# Removing inactive and removed
voter_file_cleared <- voter_file[!voter_status_desc %in% c("REMOVED", "INACTIVE")]
```

```{r}

# party change file pulled from here: https://dl.ncsbe.gov/?prefix=data/PartyChange/ 

# pulled the file from 12/1/2025, 6:00:43 AM.  

url <- "https://s3.amazonaws.com/dl.ncsbe.gov/data/PartyChange/2025_party_change_list.csv"

party_change <- read.csv(
  url,
  stringsAsFactors = FALSE,
  fileEncoding = "UTF-8"
)


#colnames(party_change) 

``` 

```{r}
library(data.table)

setDT(voter_file)
setDT(party_change)

voter_party_only <- voter_file[
  party_change,
  on = .(county_desc = county_name, voter_reg_num),
  nomatch = 0
]

colnames(voter_party_only) 
setcolorder(
  voter_party_only,
  c("year_change", "party_from", "party_to", "change_dt",
    setdiff(names(voter_party_only),
            c("year_change", "party_from", "party_to", "change_dt")))
)


``` 


```{r}
library(data.table)

fwrite(
  voter_party_only,
  "voter_with_party_changes_2025.csv"
)

getwd()
``` 
